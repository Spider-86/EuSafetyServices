<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Estudo de Segurança</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #2D2D2D;
        color: #F4F3F2;
    }

    /* TOPO */
    .topo {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 25px;
        position: relative;
    }

    .idioma-container {
        position: absolute;
        top: 0;
        right: 0;
    }

    #langSelect {
        padding: 4px 6px;
        font-size: 0.75em;
        background-color: #FFFFFF;
        color: #333;
        border: 1px solid #CCC;
        border-radius: 4px;
        width: auto;
    }

    .logo {
        height: 50px;
        margin-right: 15px;
    }

    h2#titulo {
        margin: 0;
        font-size: 1.4em;
        color: #F4F3F2;
    }

    /* CAIXAS */
    .item, .study-box {
        border: 1px solid #555;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #3A3A3A;
    }

    /* Distância entre linhas */
	.item label,
	.item textarea,
	.item select,
	.item .plCalc {
 	   margin-bottom: 6px;
  	  display: block;
	}
	input[type="file"] {
    margin-bottom: 8px; 
	}

	/* Tamanho das caixas de texto*/

	.item textarea.descricao {
    width: 450px; /* ~60 caracteres */
	}

@media (max-width: 600px) {
    .item textarea.descricao,
    .item select.S,
    .item select.F,
    .item select.P {
        width: 100% !important;
    }
}

	.item select.S,
	.item select.F,
	.item select.P {
    width: 250px; 
	}



    textarea, input[type="text"], input[type="number"], select {
        width: 100%;
        background-color: #4A4A4A;
        color: #F4F3F2;
        border: 1px solid #777;
        padding: 6px;
        border-radius: 4px;
        box-sizing: border-box;
    }

    /* Specific widths */
    #cliente, #maquina {
        width: 450px; /* approx 60 characters */
    }

    #ano {
        width: 70px; /* fits 4 digits */
        text-align: center;
    }

    input[type="file"] {
        width: 100%;
        margin-top: 8px;
        color: #F4F3F2;
    }

    button {
        padding: 10px 16px;
        background-color: #00448B;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    button:hover {
        background-color: #003366;
    }

    label.inline {
        display: block;
        margin-top: 10px;
    }

    @media (max-width: 600px) {
        #cliente, #maquina { width: 100%; }
        #ano { width: 100px; }
    }
</style>
</head>
<body>

<div class="topo">
    <img src="https://www.euchner.pt/wp-content/themes/euchner/img/logo.png" class="logo" alt="logo">

    <h2 id="titulo">Estudo de Segurança</h2>

    <div class="idioma-container">
        <select id="langSelect" onchange="atualizarIdioma()">
            <option value="pt">PT</option>
            <option value="es" selected>ES</option> <option value="en">EN</option>
        </select>
    </div>
</div>

<div class="study-box">
    <h3 id="studyTitle">Relatório Estudo de Segurnça</h3>

    <label for="cliente" id="lblCliente" class="inline">Cliente:</label>
    <input type="text" id="cliente" maxlength="60" placeholder="Nome do cliente">

    <label for="maquina" id="lblMaquina" class="inline">Nome e Modelo da Máquina:</label>
    <input type="text" id="maquina" maxlength="60" placeholder="Ex: Máquina XYZ">

    <label for="ano" id="lblAno" class="inline">Ano de Fabrico:</label>
    <input type="text" id="ano" maxlength="4" placeholder="2025">

    <label for="fotoCE" id="lblCE" class="inline">Marcação CE da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoCE">

    <label for="fotoGeral" id="lblGeral" class="inline">Foto Geral da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoGeral">
</div>

<div id="container"></div>

<button id="btnAdd" onclick="addItem()">Adicionar Função</button>
<button id="btnPDF" onclick="gerarPDF()">Gerar PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ---- TEXTOS MULTILINGUE ---- */
const textos = {
    pt: {
        titulo: "Estudo de Segurança",
        studyTitle: "Relatório de Estudo de Segurança",
        cliente: "Cliente:",
        maquina: "Nome e Modelo da Máquina:",
        ano: "Ano de Fabrico:",
        ce: "Marcação CE da Máquina:",
        geral: "Foto Geral da Máquina:",
        descricao: "Descrição:",
        fotos: "Fotos",
        foto: "Foto",
        addFuncao: "Adicionar Ficha de Perigo",
        gerarPDF: "Gerar PDF",
        funcao: "Ficha de Perigo"
    },
    es: {
        titulo: "Informe Estudio de Seguridad",
        studyTitle: "Información del Estudio",
        cliente: "Cliente:",
        maquina: "Nombre y Modelo de la Máquina:",
        ano: "Año de Fabricación:",
        ce: "Marcado CE de la Máquina:",
        geral: "Foto General de la Máquina:",
        descricao: "Descripción:",
        fotos: "Fotos",
        foto: "Foto",
        addFuncao: "Añadir Ficha de Peligro",
        gerarPDF: "Generar PDF",
        funcao: "Ficha de Peligro"
    },
    en: {
        titulo: "Safety Study Report",
        studyTitle: "Study Information",
        cliente: "Client:",
        maquina: "Machine Name and Model:",
        ano: "Year of Manufacture:",
        ce: "Machine CE Marking:",
        geral: "General Machine Photo:",
        descricao: "Description:",
        fotos: "Photos",
        foto: "Photo",
        addFuncao: "Add Hazard Sheet",
        gerarPDF: "Generate PDF",
        funcao: "Hazard Sheet"
    }
};

let contador = 0;

/* ---- IDIOMA ---- */
function atualizarIdioma() {
    const lang = document.getElementById("langSelect").value;
    const t = textos[lang];

    document.getElementById("titulo").innerText = t.titulo;
    document.getElementById("studyTitle").innerText = t.studyTitle;
    document.getElementById("lblCliente").innerText = t.cliente;
    document.getElementById("lblMaquina").innerText = t.maquina;
    document.getElementById("lblAno").innerText = t.ano;
    document.getElementById("lblCE").innerText = t.ce;
    document.getElementById("lblGeral").innerText = t.geral;

    document.getElementById("btnAdd").innerText = t.addFuncao;
    document.getElementById("btnPDF").innerText = t.gerarPDF;

    // atualizar itens existentes
    document.querySelectorAll(".item").forEach((item, idx) => {
        item.querySelector(".hFuncao").innerText = `${t.funcao} ${idx+1}`;
        item.querySelector(".lblDescricao").innerText = t.descricao;
        item.querySelector(".lblFotos").innerText = t.fotos;
        // Assegurar que só as fotos 1 e 2 são atualizadas, removendo a referência à foto 3
        const fotosLabels = item.querySelectorAll(".lblFoto");
        if(fotosLabels.length >= 1) fotosLabels[0].innerText = `${t.foto} 1:`;
        if(fotosLabels.length >= 2) fotosLabels[1].innerText = `${t.foto} 2:`;
    });
}

/* ---- ADICIONAR FUNÇÃO ---- */
function addItem() {
    contador++;
    const lang = document.getElementById("langSelect").value;
    const t = textos[lang];

    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
        <h3 class="hFuncao">${t.funcao} ${contador}</h3>

        <label class="lblDescricao">${t.descricao}</label>
        <textarea class="descricao" rows="3"></textarea>

        <label class="lblFotos">${t.fotos}</label>
        <label class="lblFoto">${t.foto} 1:</label>
        <input type="file" accept="image/*" capture="camera" class="foto1">

        <label class="lblFoto">${t.foto} 2:</label>
        <input type="file" accept="image/*" capture="camera" class="foto2">
        `;

    document.getElementById("container").appendChild(div);
}

// ----------------------------------------------------------------------
// NOVAS FUNÇÕES PARA CORRIGIR A ORIENTAÇÃO DA IMAGEM (EXIF)
// ----------------------------------------------------------------------

// Função para ler o valor de orientação EXIF (Simplificado)
function getOrientation(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const view = new DataView(e.target.result);
        if (view.getUint16(0, false) != 0xFFD8) return callback(-2); // Não é JPEG

        const length = view.byteLength;
        let offset = 2;

        while (offset < length) {
            const marker = view.getUint16(offset, false);
            offset += 2;

            if (marker == 0xFFE1) {
                // APP1 (EXIF)
                if (view.getUint32(offset += 2, false) != 0x45786966) return callback(-1); // Não é EXIF

                const tiffOffset = offset + 6;
                const littleEndian = view.getUint16(tiffOffset) == 0x4949;
                offset = view.getUint32(tiffOffset + 4, littleEndian) + tiffOffset;
                const entries = view.getUint16(offset, littleEndian);
                offset += 2;

                for (let i = 0; i < entries; i++) {
                    if (view.getUint16(offset + (i * 12), littleEndian) == 0x0112) {
                        return callback(view.getUint16(offset + (i * 12) + 8, littleEndian));
                    }
                }
            } else if ((marker & 0xFF00) != 0xFF00) {
                break;
            } else {
                offset += view.getUint16(offset, false);
            }
        }
        return callback(-1); // Não encontrado
    };
    reader.readAsArrayBuffer(file.slice(0, 65536)); // Ler apenas o início do ficheiro
}

// Função para corrigir a orientação no Canvas
function resetOrientation(srcBase64, orientation, callback) {
    const img = new Image();
    img.onload = function() {
        const width = img.width;
        const height = img.height;
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Configurar o Canvas para a nova orientação
        if (orientation > 4) {
            canvas.width = height;
            canvas.height = width;
        } else {
            canvas.width = width;
            canvas.height = height;
        }

        // Aplicar a transformação de rotação/espelhamento
        switch (orientation) {
            case 2: ctx.transform(-1, 0, 0, 1, width, 0); break;
            case 3: ctx.transform(-1, 0, 0, -1, width, height); break;
            case 4: ctx.transform(1, 0, 0, -1, 0, height); break;
            case 5: ctx.transform(0, 1, 1, 0, 0, 0); break;
            case 6: ctx.transform(0, 1, -1, 0, height, 0); break;
            case 7: ctx.transform(0, -1, -1, 0, height, width); break;
            case 8: ctx.transform(0, -1, 1, 0, 0, width); break;
            default: break;
        }

        ctx.drawImage(img, 0, 0);

        // Retornar o Data URL corrigido (JPEG de qualidade 90%)
        callback(canvas.toDataURL('image/jpeg', 0.9));
    };
    img.src = srcBase64;
}

/* ---- util: File -> dataURL (MODIFICADA) ---- */
function fileToDataURL(file){
    return new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = async function(e) {
            const dataURL = e.target.result;

            // 1. Obter a orientação EXIF
            getOrientation(file, (orientation) => {
                if (orientation > 1) {
                    // 2. Corrigir a orientação e obter o Data URL corrigido
                    resetOrientation(dataURL, orientation, (correctedDataURL) => {
                        res(correctedDataURL);
                    });
                } else {
                    // Sem correção necessária
                    res(dataURL);
                }
            });
        };
        reader.onerror = e=> rej(e);
        reader.readAsDataURL(file);
    });
}
// Fim das modificações

/* ---- adicionar imagem ao PDF dimensionada ---- */
async function addImageFullSize(doc, dataUrl, x, y, maxW = 180, maxH = 120){
    return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
            const pxToMm = px => px * 25.4 / 96;
            let w = pxToMm(img.width);
            let h = pxToMm(img.height);
            if(w > maxW || h > maxH){
                const r = Math.min(maxW/w, maxH/h);
                w *= r; h *= r;
            }
            // Adicionar a imagem corrigida ao PDF
            doc.addImage(dataUrl, 'JPEG', x, y, w, h);
            resolve(h + 8);
        };
        img.src = dataUrl;
    });
}

/* ---- GERAR PDF (robusto) ---- */
async function gerarPDF(){
    if(!window.jspdf || !window.jspdf.jsPDF){
        alert('Biblioteca jsPDF não carregada.');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
    const lang = document.getElementById('langSelect').value;
    const t = textos[lang];

    let y = 12;

    // LOGO
    try {
        const logoResp = await fetch('https://www.euchner.pt/wp-content/themes/euchner/img/logo.png', {mode:'cors'});
        const logoBlob = await logoResp.blob();
        const logoDataUrl = await new Promise(res=>{
            const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(logoBlob);
        });
        const logoW = 70; const logoX = (210 - logoW)/2;
        await addImageFullSize(doc, logoDataUrl, logoX, y, 70, 20);
        y += 28;
    } catch(e){
        console.warn('Logo: ', e);
    }

    // TITULO E DADOS DO ESTUDO
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text(t.studyTitle, 10, y); y += 8;
    doc.setFontSize(11);
    doc.text(`${t.cliente} ${document.getElementById('cliente').value || ''}`, 10, y); y+=6;
    doc.text(`${t.maquina} ${document.getElementById('maquina').value || ''}`, 10, y); y+=6;
    doc.text(`${t.ano} ${document.getElementById('ano').value || ''}`, 10, y); y+=8;

    // FOTOS DO ESTUDO (CE + GERAL)
    const fotoCEFile = document.getElementById('fotoCE').files[0];
    if(fotoCEFile){
        doc.setFontSize(11);
        doc.text(t.ce, 10, y); y+=6;
        const dataUrl = await fileToDataURL(fotoCEFile); // Usa a função corrigida
        const h = await addImageFullSize(doc, dataUrl, 10, y, 90, 80);
        y += h;
    }

    const fotoGeralFile = document.getElementById('fotoGeral').files[0];
    if(fotoGeralFile){
        if(y > 250){ doc.addPage(); y = 12; }
        doc.setFontSize(11);
        doc.text(t.geral, 10, y); y+=6;
        const dataUrl = await fileToDataURL(fotoGeralFile); // Usa a função corrigida
        const h = await addImageFullSize(doc, dataUrl, 10, y, 180, 120);
        y += h;
    }

    // FUNÇÕES
    const items = document.querySelectorAll('.item');
    if(items.length === 0){
        doc.save('Estudo_de_Seguranca.pdf');
        return;
    }

    doc.addPage(); y = 12;

    for(let i=0;i<items.length;i++){
        const item = items[i];
        doc.setFontSize(13);
        doc.text(`${t.funcao} ${i+1}`, 10, y); y += 7;
        doc.setFontSize(11);
        const desc = item.querySelector('.descricao').value || '';
        doc.text(`${t.descricao} ${desc}`, 10, y); y += 8; // Ajuste no espaçamento após remover PL

        // Atualização para considerar apenas as fotos 1 e 2
        const fotos = [
            item.querySelector('.foto1')?.files?.[0],
            item.querySelector('.foto2')?.files?.[0]
        ].filter(Boolean);

        for(const f of fotos){
            if(y > 220){ doc.addPage(); y = 12; }
            const dataUrl = await fileToDataURL(f); // Usa a função corrigida
            const h = await addImageFullSize(doc, dataUrl, 10, y, 180, 120);
            y += h;
        }

        if(i < items.length - 1){
            doc.addPage(); y = 12;
        }
    }

    doc.save('Estudo_de_Seguranca.pdf');
}

/* ---- inicializar idioma padrão (Espanhol) ---- */
atualizarIdioma();

</script>
</body>
</html>
