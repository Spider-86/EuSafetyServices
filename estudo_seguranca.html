<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Estudo de Segurança</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #2D2D2D;
        color: #F4F3F2;
    }

    /* TOPO */
    .topo {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 25px;
        position: relative;
    }

    .idioma-container {
        position: absolute;
        top: 0;
        right: 0;
    }

    #langSelect {
        padding: 4px 6px;
        font-size: 0.75em;
        background-color: #FFFFFF;
        color: #333;
        border: 1px solid #CCC;
        border-radius: 4px;
        width: auto;
    }

    .logo {
        height: 50px;
        margin-right: 15px;
    }

    h2#titulo {
        margin: 0;
        font-size: 1.4em;
        color: #F4F3F2;
    }

    /* CAIXAS */
    .item, .study-box {
        border: 1px solid #555;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #3A3A3A;
    }

    /* Distância entre linhas */
	.item label,
	.item textarea,
	.item select,
	.item .plCalc {
 	   margin-bottom: 6px;
  	  display: block;
	}
	input[type="file"] {
    margin-bottom: 8px; 
	}

	/* Tamanho das caixas de texto*/

	.item textarea.descricao {
    width: 450px; /* ~60 caracteres */
	}

@media (max-width: 600px) {
    .item textarea.descricao,
    .item select.S,
    .item select.F,
    .item select.P {
        width: 100% !important;
    }
}

	.item select.S,
	.item select.F,
	.item select.P {
    width: 250px; 
	}



    textarea, input[type="text"], input[type="number"], select {
        width: 100%;
        background-color: #4A4A4A;
        color: #F4F3F2;
        border: 1px solid #777;
        padding: 6px;
        border-radius: 4px;
        box-sizing: border-box;
    }

    /* Specific widths */
    #cliente, #maquina {
        width: 450px; /* approx 60 characters */
    }

    #ano {
        width: 70px; /* fits 4 digits */
        text-align: center;
    }

    input[type="file"] {
        width: 100%;
        margin-top: 8px;
        color: #F4F3F2;
    }

    button {
        padding: 10px 16px;
        background-color: #00448B;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    button:hover {
        background-color: #003366;
    }

    label.inline {
        display: block;
        margin-top: 10px;
    }
    
    /* Novo estilo para o botão HTML */
    #btnHTML {
        background-color: #007bff; /* Azul para HTML (Editável) */
    }


    @media (max-width: 600px) {
        #cliente, #maquina { width: 100%; }
        #ano { width: 100px; }
    }
</style>
</head>
<body>

<div class="topo">
    <img src="https://www.euchner.pt/wp-content/themes/euchner/img/logo.png" class="logo" alt="logo">

    <h2 id="titulo">Estudo de Segurança</h2>

    <div class="idioma-container">
        <select id="langSelect" onchange="atualizarIdioma()">
            <option value="pt">PT</option>
            <option value="es" selected>ES</option> <option value="en">EN</option>
        </select>
    </div>
</div>

<div class="study-box">
    <h3 id="studyTitle">Relatório Estudo de Segurnça</h3>

    <label for="cliente" id="lblCliente" class="inline">Cliente:</label>
    <input type="text" id="cliente" maxlength="60" placeholder="Nome do cliente">

    <label for="maquina" id="lblMaquina" class="inline">Nome e Modelo da Máquina:</label>
    <input type="text" id="maquina" maxlength="60" placeholder="Ex: Máquina XYZ">

    <label for="ano" id="lblAno" class="inline">Ano de Fabrico:</label>
    <input type="text" id="ano" maxlength="4" placeholder="2025">

    <label for="fotoCE" id="lblCE" class="inline">Marcação CE da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoCE">

    <label for="fotoGeral" id="lblGeral" class="inline">Foto Geral da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoGeral">
</div>

<div id="container"></div>

<button id="btnAdd" onclick="addItem()">Adicionar Função</button>
<button id="btnPDF" onclick="gerarPDF()">Gerar PDF</button>
<button id="btnHTML" onclick="generateHtml()">Gerar HTML (Editável)</button> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ---- TEXTOS MULTILINGUE ---- */
const textos = {
    pt: {
        titulo: "Estudo de Segurança",
        studyTitle: "Relatório de Estudo de Segurança",
        cliente: "Cliente:",
        maquina: "Nome e Modelo da Máquina:",
        ano: "Ano de Fabrico:",
        ce: "Marcação CE da Máquina:",
        geral: "Foto Geral da Máquina:",
        descricao: "Descrição:",
        fotos: "Fotos",
        foto: "Foto",
        addFuncao: "Adicionar Ficha de Perigo",
        gerarPDF: "Gerar PDF",
        funcao: "Ficha de Perigo"
    },
    es: {
        titulo: "Informe Estudio de Seguridad",
        studyTitle: "Información del Estudio",
        cliente: "Cliente:",
        maquina: "Nombre y Modelo de la Máquina:",
        ano: "Año de Fabricación:",
        ce: "Marcado CE de la Máquina:",
        geral: "Foto General de la Máquina:",
        descricao: "Descripción:",
        fotos: "Fotos",
        foto: "Foto",
        addFuncao: "Añadir Ficha de Peligro",
        gerarPDF: "Generar PDF",
        funcao: "Ficha de Peligro"
    },
    en: {
        titulo: "Safety Study Report",
        studyTitle: "Study Information",
        cliente: "Client:",
        maquina: "Machine Name and Model:",
        ano: "Year of Manufacture:",
        ce: "Machine CE Marking:",
        geral: "General Machine Photo:",
        descricao: "Description:",
        fotos: "Photos",
        foto: "Photo",
        addFuncao: "Add Hazard Sheet",
        gerarPDF: "Generate PDF",
        funcao: "Hazard Sheet"
    }
};

let contador = 0;

/* ---- IDIOMA ---- */
function atualizarIdioma() {
    const lang = document.getElementById("langSelect").value;
    const t = textos[lang];

    document.getElementById("titulo").innerText = t.titulo;
    document.getElementById("studyTitle").innerText = t.studyTitle;
    document.getElementById("lblCliente").innerText = t.cliente;
    document.getElementById("lblMaquina").innerText = t.maquina;
    document.getElementById("lblAno").innerText = t.ano;
    document.getElementById("lblCE").innerText = t.ce;
    document.getElementById("lblGeral").innerText = t.geral;

    document.getElementById("btnAdd").innerText = t.addFuncao;
    document.getElementById("btnPDF").innerText = t.gerarPDF;

    // atualizar itens existentes
    document.querySelectorAll(".item").forEach((item, idx) => {
        item.querySelector(".hFuncao").innerText = `${t.funcao} ${idx+1}`;
        item.querySelector(".lblDescricao").innerText = t.descricao;
        item.querySelector(".lblFotos").innerText = t.fotos;
        // O loop agora só encontra foto 1 e foto 2 e numera corretamente
        item.querySelectorAll(".lblFoto").forEach((f,i)=> f.innerText = `${t.foto} ${i+1}:`);
    });
}

/* ---- ADICIONAR FUNÇÃO (AGORA SÓ COM 2 FOTOS) ---- */
function addItem() {
    contador++;
    const lang = document.getElementById("langSelect").value;
    const t = textos[lang];

    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
        <h3 class="hFuncao">${t.funcao} ${contador}</h3>

        <label class="lblDescricao">${t.descricao}</label>
        <textarea class="descricao" rows="3"></textarea>

        <label class="lblFotos">${t.fotos}</label>
        <label class="lblFoto">${t.foto} 1:</label>
        <input type="file" accept="image/*" capture="camera" class="foto1">

        <label class="lblFoto">${t.foto} 2:</label>
        <input type="file" accept="image/*" capture="camera" class="foto2">
    `; // FOTO 3 REMOVIDA

    document.getElementById("container").appendChild(div);
}

/* ---- util: File -> dataURL ---- */
function fileToDataURL(file){
    return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=> res(r.result);
        r.onerror = e=> rej(e);
        r.readAsDataURL(file);
    });
}

/* ---- adicionar imagem ao PDF dimensionada ---- */
async function addImageFullSize(doc, dataUrl, x, y, maxW = 180, maxH = 120){
    return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
            const pxToMm = px => px * 25.4 / 96;
            let w = pxToMm(img.width);
            let h = pxToMm(img.height);
            if(w > maxW || h > maxH){
                const r = Math.min(maxW/w, maxH/h);
                w *= r; h *= r;
            }
            doc.addImage(dataUrl, 'JPEG', x, y, w, h);
            resolve(h + 8);
        };
        img.src = dataUrl;
    });
}

/* ---- GERAR PDF (robusto, AGORA SÓ COM 2 FOTOS POR FUNÇÃO) ---- */
async function gerarPDF(){
    if(!window.jspdf || !window.jspdf.jsPDF){
        alert('Biblioteca jsPDF não carregada.');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'mm', format:'a4', orientation:'portrait' });
    const lang = document.getElementById('langSelect').value;
    const t = textos[lang];

    let y = 12;

    // LOGO
    try {
        const logoResp = await fetch('https://www.euchner.pt/wp-content/themes/euchner/img/logo.png', {mode:'cors'});
        const logoBlob = await logoResp.blob();
        const logoDataUrl = await new Promise(res=>{
            const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(logoBlob);
        });
        const logoW = 70; const logoX = (210 - logoW)/2;
        await addImageFullSize(doc, logoDataUrl, logoX, y, 70, 20);
        y += 28;
    } catch(e){
        console.warn('Logo: ', e);
    }

    // TITULO E DADOS DO ESTUDO
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text(t.studyTitle, 10, y); y += 8;
    doc.setFontSize(11);
    doc.text(`${t.cliente} ${document.getElementById('cliente').value || ''}`, 10, y); y+=6;
    doc.text(`${t.maquina} ${document.getElementById('maquina').value || ''}`, 10, y); y+=6;
    doc.text(`${t.ano} ${document.getElementById('ano').value || ''}`, 10, y); y+=8;

    // FOTOS DO ESTUDO (CE + GERAL)
    const fotoCEFile = document.getElementById('fotoCE').files[0];
    if(fotoCEFile){
        doc.setFontSize(11);
        doc.text(t.ce, 10, y); y+=6;
        const dataUrl = await fileToDataURL(fotoCEFile);
        const h = await addImageFullSize(doc, dataUrl, 10, y, 90, 80);
        y += h;
    }

    const fotoGeralFile = document.getElementById('fotoGeral').files[0];
    if(fotoGeralFile){
        if(y > 250){ doc.addPage(); y = 12; }
        doc.setFontSize(11);
        doc.text(t.geral, 10, y); y+=6;
        const dataUrl = await fileToDataURL(fotoGeralFile);
        const h = await addImageFullSize(doc, dataUrl, 10, y, 180, 120);
        y += h;
    }

    // FUNÇÕES
    const items = document.querySelectorAll('.item');
    if(items.length === 0){
        doc.save('Estudo_de_Seguranca.pdf');
        return;
    }

    doc.addPage(); y = 12;

    for(let i=0;i<items.length;i++){
        const item = items[i];
        doc.setFontSize(13);
        doc.text(`${t.funcao} ${i+1}`, 10, y); y += 7;
        doc.setFontSize(11);
        const desc = item.querySelector('.descricao').value || '';
        doc.text(`${t.descricao} ${desc}`, 10, y); y += 8; // Ajuste no espaçamento

        // APENAS FOTO 1 E FOTO 2
        const fotos = [
            item.querySelector('.foto1')?.files?.[0],
            item.querySelector('.foto2')?.files?.[0]
        ].filter(Boolean);

        for(const f of fotos){
            if(y > 220){ doc.addPage(); y = 12; }
            const dataUrl = await fileToDataURL(f);
            const h = await addImageFullSize(doc, dataUrl, 10, y, 180, 120);
            y += h;
        }

        if(i < items.length - 1){
            doc.addPage(); y = 12;
        }
    }

    doc.save('Estudo_de_Seguranca.pdf');
}


/* ---- GERAÇÃO DE HTML (NOVO CÓDIGO EDITÁVEL) ---- */

/** Gera o HTML formatado para ser aberto e editado no Word. */
async function generateHtml() {
    const langSelect = document.getElementById('langSelect');
    const t = textos[langSelect.value];
    
    const cliente = document.getElementById('cliente').value || 'N/A';
    const maquina = document.getElementById('maquina').value || 'N/A';
    const geralText = document.getElementById('textoGeral').value || '';
    const fotoGeralFile = document.getElementById('fotoGeral')?.files?.[0];
    
    // Início da Estrutura HTML
    let htmlContent = `
    <!DOCTYPE html>
    <html lang="${langSelect.value}">
    <head>
        <meta charset="UTF-8">
        <title>Documento Editável - ${t.titulo}</title>
        <style>
            /* Estes estilos afetam SÓ o ficheiro HTML GERADO (para abrir no Word/Docs). */
            body { font-family: Arial, sans-serif; line-height: 1.6; margin: 40px; color: #333; }
            h1 { border-bottom: 3px solid #0056b3; padding-bottom: 8px; color: #0056b3; }
            h2 { color: #007bff; margin-top: 30px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
            h3 { color: #333; margin-top: 20px; }
            .info-box { margin-bottom: 15px; background-color: #f8f9fa; padding: 10px; border-left: 5px solid #007bff; }
            .info-box p { margin: 5px 0; }
            .section-content { margin-bottom: 30px; }
            .image-container { margin: 20px 0; text-align: center; page-break-inside: avoid; }
            img { max-width: 80%; height: auto; display: block; margin: 0 auto; border: 1px solid #ddd; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
            .item-section { page-break-inside: avoid; margin-bottom: 40px; border: 1px solid #ccc; padding: 15px; border-radius: 5px;}
            .fotos-row { display: flex; justify-content: space-around; gap: 10px; }
            .fotos-row .image-container { flex: 1; margin: 10px 0; }
            .fotos-row img { max-width: 100%; }
        </style>
    </head>
    <body>
    
    <h1>${t.titulo}</h1>
    
    <div class="info-box">
        <p><strong>${t.cliente}</strong> ${cliente}</p>
        <p><strong>${t.maquina}</strong> ${maquina}</p>
        <p><strong>${t.ano}</strong> ${document.getElementById('ano').value || 'N/A'}</p>
    </div>
    
    <h2>${t.geral}</h2>
    <div class="section-content">
        <p>${geralText.replace(/\n/g, '<br>')}</p>
    `;
    
    // Adicionar a Imagem Geral
    if (fotoGeralFile) {
        const dataUrl = await fileToDataURL(fotoGeralFile); 
        htmlContent += `<div class="image-container"><img src="${dataUrl}" alt="Foto Geral"></div>`;
    }
    htmlContent += `</div>`;


    // 5. Loop Funções (Items)
    const items = document.querySelectorAll('.item');
    
    if (items.length > 0) {
        htmlContent += `<h2>Fichas de Análise por Função</h2>`; // Usar um título genérico
    }

    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const desc = item.querySelector('.descricao').value || 'N/A';
        
        htmlContent += `
        <div class="item-section">
            <h3>${t.funcao} ${i + 1}</h3>
            <p><strong>${t.descricao}</strong> ${desc.replace(/\n/g, '<br>')}</p>
            
            <div class="fotos-row">
        `;

        // APENAS FOTO 1 E FOTO 2
        const fotos = [
            item.querySelector('.foto1')?.files?.[0],
            item.querySelector('.foto2')?.files?.[0]
        ].filter(Boolean);

        // Adicionar as fotos de cada item
        for (const f of fotos) {
            const dataUrlItem = await fileToDataURL(f);
            htmlContent += `<div class="image-container"><img src="${dataUrlItem}" alt="${t.funcao} ${i+1} Foto"></div>`;
        }
        
        // Adicionar placeholders vazios para manter o layout de 2 colunas mesmo com 1 foto
        if (fotos.length < 2) {
             htmlContent += `<div class="image-container"></div>`;
        }
        
        htmlContent += `
            </div> 
        </div>
        `;
    }

    htmlContent += `
    </body>
    </html>
    `;

    // 6. Iniciar o download
    downloadHtmlFile(htmlContent, 'Estudo_de_Seguranca_Editavel.html');
}

/** Utilitário para acionar o download do arquivo HTML. */
function downloadHtmlFile(content, fileName) {
    const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href); 
}

/* ---- inicializar idioma padrão (Espanhol) ---- */
atualizarIdioma();

</script>
</body>
</html>
