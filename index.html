<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>Estudo de Segurança</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #2D2D2D; color: #F4F3F2; }
    .topo { display:flex; align-items:center; justify-content:flex-start; margin-bottom:25px; position:relative; }
    .idioma-container { position:absolute; top:0; right:0; }
    #langSelect { padding:4px 6px; font-size:0.75em; background-color:#FFF; color:#333; border:1px solid #CCC; border-radius:4px; width:auto; }
    .logo { height:50px; margin-right:15px; }
    h2#titulo { margin:0; font-size:1.4em; color:#F4F3F2; }
    .item, .study-box { border:1px solid #555; padding:15px; margin-bottom:20px; border-radius:8px; background-color:#3A3A3A; }
    .item label, .item textarea, .item select, .item .plCalc { margin-bottom:6px; display:block; }
    input[type="file"] { margin-bottom:8px; width:100%; margin-top:8px; color:#F4F3F2; }
    textarea, input[type="text"], input[type="number"], select { width:100%; background-color:#4A4A4A; color:#F4F3F2; border:1px solid #777; padding:6px; border-radius:4px; box-sizing:border-box; }
    #cliente, #maquina { width:450px; }
    #ano { width:70px; text-align:center; }
    button { padding:10px 16px; background-color:#00448B; color:white; border:none; border-radius:4px; cursor:pointer; margin-right:10px; }
    button:hover { background-color:#003366; }
    label.inline { display:block; margin-top:10px; }
    @media (max-width: 600px) { #cliente, #maquina { width:100%; } #ano { width:100px; } }
</style>
</head>
<body>

<div class="topo">
    <img src="https://www.euchner.pt/wp-content/themes/euchner/img/logo.png" class="logo" alt="logo" />
    <h2 id="titulo">Estudo de Segurança</h2>
    <div class="idioma-container">
        <select id="langSelect" onchange="atualizarIdioma()">
            <option value="pt">PT</option>
            <option value="es">ES</option>
            <option value="en">EN</option>
        </select>
    </div>
</div>

<div class="study-box">
    <h3 id="studyTitle">Relatório Estudo de Segurança</h3>
    <label for="cliente" id="lblCliente" class="inline">Cliente:</label>
    <input type="text" id="cliente" maxlength="60" placeholder="Nome do cliente" />
    <label for="maquina" id="lblMaquina" class="inline">Nome e Modelo da Máquina:</label>
    <input type="text" id="maquina" maxlength="60" placeholder="Ex: Máquina XYZ" />
    <label for="ano" id="lblAno" class="inline">Ano de Fabrico:</label>
    <input type="text" id="ano" maxlength="4" placeholder="2025" />
    <label for="fotoCE" id="lblCE" class="inline">Marcação CE da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoCE" />
    <label for="fotoGeral" id="lblGeral" class="inline">Foto Geral da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoGeral" />
</div>

<div id="container"></div>

<button id="btnAdd" onclick="addItem()">Adicionar Função</button>
<button id="btnPDF" onclick="gerarPDF()">Gerar PDF</button>
<span id="loadingMsg" style="display:none; margin-left:10px;">A gerar PDF, aguarde...</span>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script>
const textos = {
    pt:{titulo:"Estudo de Segurança",studyTitle:"Relatório de Estudo de Segurança",cliente:"Cliente:",maquina:"Nome e Modelo da Máquina:",ano:"Ano de Fabrico:",ce:"Marcação CE da Máquina:",geral:"Foto Geral da Máquina:",descricao:"Descrição:",pl:"Determinar Performance Level (PLr)",severidade:"Severidade da lesão (S):",frequencia:"Frequência / exposição ao perigo (F):",possibilidade:"Possibilidade de evitar (P):",fotos:"Fotos",foto:"Foto",addFuncao:"Adicionar Função",gerarPDF:"Gerar PDF",funcao:"Função",plCalculado:"PL calculado:"},
    es:{titulo:"Informe Estudio de Seguridad",studyTitle:"Información del Estudio",cliente:"Cliente:",maquina:"Nombre y Modelo de la Máquina:",ano:"Año de Fabricación:",ce:"Marcado CE de la Máquina:",geral:"Foto General de la Máquina:",descricao:"Descripción:",pl:"Determinar Nivel de Rendimiento (PLr)",severidade:"Gravedad de la lesión (S):",frequencia:"Frecuencia / exposición al peligro (F):",possibilidade:"Posibilidad de evitar (P):",fotos:"Fotos",foto:"Foto",addFuncao:"Añadir Función",gerarPDF:"Generar PDF",funcao:"Función",plCalculado:"PL calculado:"},
    en:{titulo:"Safety Study Report",studyTitle:"Study Information",cliente:"Client:",maquina:"Machine Name and Model:",ano:"Year of Manufacture:",ce:"Machine CE Marking:",geral:"General Machine Photo:",descricao:"Description:",pl:"Determine Performance Level (PLr)",severidade:"Severity of injury (S):",frequencia:"Frequency / exposure to hazard (F):",possibilidade:"Possibility of avoiding (P):",fotos:"Photos",foto:"Photo",addFuncao:"Add Function",gerarPDF:"Generate PDF",funcao:"Function",plCalculado:"Calculated PL:"}
};

let contador = 0;

function atualizarIdioma(){
    const lang = document.getElementById("langSelect").value;
    const t = textos[lang];
    document.getElementById("titulo").innerText = t.titulo;
    document.getElementById("studyTitle").innerText = t.studyTitle;
    document.getElementById("lblCliente").innerText = t.cliente;
    document.getElementById("lblMaquina").innerText = t.maquina;
    document.getElementById("lblAno").innerText = t.ano;
    document.getElementById("lblCE").innerText = t.ce;
    document.getElementById("lblGeral").innerText = t.geral;
    document.getElementById("btnAdd").innerText = t.addFuncao;
    document.getElementById("btnPDF").innerText = t.gerarPDF;
    document.querySelectorAll(".item").forEach((item,idx)=>{
        item.querySelector(".hFuncao").innerText = `${t.funcao} ${idx+1}`;
        item.querySelector(".lblDescricao").innerText = t.descricao;
        item.querySelector(".lblS").innerText = t.severidade;
        item.querySelector(".lblF").innerText = t.frequencia;
        item.querySelector(".lblP").innerText = t.possibilidade;
        item.querySelector(".plCalc").innerText = t.plCalculado;
        item.querySelectorAll(".lblFoto").forEach((f,i)=> f.innerText=`${t.foto} ${i+1}:`);
    });
}

function addItem(){
    contador++;
    const lang = document.getElementById("langSelect").value;
    const t = textos[lang];
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
        <h3 class="hFuncao">${t.funcao} ${contador}</h3>
        <label class="lblDescricao">${t.descricao}</label>
        <textarea class="descricao" rows="3"></textarea>
        <label class="lblS">${t.severidade}</label>
        <select class="S" onchange="atualizarPL(this)">
            <option value="S1">S1 - Slight Injury</option>
            <option value="S2">S2 - Serious Injury Including Death</option>
        </select>
        <label class="lblF">${t.frequencia}</label>
        <select class="F" onchange="atualizarPL(this)">
            <option value="F1">F1 - Seldom to Quite Often</option>
            <option value="F2">F2 - Frequent to Continuous</option>
        </select>
        <label class="lblP">${t.possibilidade}</label>
        <select class="P" onchange="atualizarPL(this)">
            <option value="P1">P1 - Possible</option>
            <option value="P2">P2 - Nearly Impossible</option>
        </select>
        <div class="plCalc">${t.plCalculado} <span class="plDisplay">—</span></div>
        <label class="lblFoto">${t.foto} 1:</label>
        <input type="file" accept="image/*" capture="camera" class="foto1">
        <label class="lblFoto">${t.foto} 2:</label>
        <input type="file" accept="image/*" capture="camera" class="foto2">
        <label class="lblFoto">${t.foto} 3:</label>
        <input type="file" accept="image/*" capture="camera" class="foto3">
    `;
    document.getElementById("container").appendChild(div);
    atualizarPL(div);
}

function atualizarPL(el){
    const item = el.closest(".item");
    const val = calcularPL(item);
    item.querySelector(".plDisplay").innerText = val || '—';
}

function calcularPL(item){
    const S = item.querySelector(".S").value;
    const F = item.querySelector(".F").value;
    const P = item.querySelector(".P").value;
    const key = S+F+P;
    const map = {'S1F1P1':'a','S1F1P2':'b','S1F2P1':'b','S1F2P2':'c','S2F1P1':'c','S2F1P2':'d','S2F2P1':'d','S2F2P2':'e'};
    return map[key] || '—';
}

// ===================== PDF Helpers =====================
function checkPageSpace(doc, currentY, imgHeightMm, margin=12){
    const pageHeight = doc.internal.pageSize.getHeight();
    if(currentY + imgHeightMm + margin > pageHeight){
        doc.addPage();
        return margin;
    }
    return currentY;
}

async function fileToDataURLResized(file, maxWidth=1024, maxHeight=1024, quality=0.8){
    return new Promise((resolve,reject)=>{
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = ()=>{
            EXIF.getData(img,function(){
                const orientation = EXIF.getTag(this,'Orientation') || 1;
                let width=img.width, height=img.height;
                const scale=Math.min(maxWidth/width,maxHeight/height,1);
                width*=scale; height*=scale;

                const canvas = document.createElement('canvas');
                if([5,6,7,8].includes(orientation)){ canvas.width=height; canvas.height=width; } 
                else { canvas.width=width; canvas.height=height; }

                const ctx = canvas.getContext('2d');
                switch(orientation){
                    case 2: ctx.transform(-1,0,0,1,width,0); break;
                    case 3: ctx.transform(-1,0,0,-1,width,height); break;
                    case 4: ctx.transform(1,0,0,-1,0,height); break;
                    case 5: ctx.transform(0,1,1,0,0,0); break;
                    case 6: ctx.transform(0,1,-1,0,height,0); break;
                    case 7: ctx.transform(0,-1,-1,0,height,width); break;
                    case 8: ctx.transform(0,-1,1,0,0,width); break;
                }
                ctx.drawImage(img,0,0,width,height);
                canvas.toBlob(blob=>{
                    const reader=new FileReader();
                    reader.onloadend=()=>{ URL.revokeObjectURL(url); resolve(reader.result); };
                    reader.readAsDataURL(blob);
                },'image/jpeg',quality);
            });
        };
        img.onerror=()=>{ URL.revokeObjectURL(url); reject(new Error("Erro ao carregar imagem")); };
        img.src = url;
    });
}

async function addImageFullSize(doc,dataUrl,x,y,maxW=180,maxH=120){
    return new Promise(resolve=>{
        const img = new Image();
        img.onload=()=>{
            const pxToMm=px=>px*25.4/96;
            let w=pxToMm(img.width),h=pxToMm(img.height);
            if(w>maxW||h>maxH){ const r=Math.min(maxW/w,maxH/h); w*=r; h*=r; }
            y = checkPageSpace(doc, y, h);
            doc.addImage(dataUrl,'JPEG',x,y,w,h);
            resolve(h+8);
        };
        img.src=dataUrl;
    });
}

// ===================== Gerar PDF =====================
async function gerarPDF(){
    const btn=document.getElementById('btnPDF');
    const loadingMsg=document.getElementById('loadingMsg');
    btn.disabled=true; loadingMsg.style.display='inline';
    try{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
        const lang=document.getElementById('langSelect').value;
        const t=textos[lang];
        let y=12;

        // LOGO
        try{
            const logoResp = await fetch('https://www.euchner.pt/wp-content/themes/euchner/img/logo.png',{mode:'cors'});
            const logoBlob = await logoResp.blob();
            const logoDataUrl = await new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(logoBlob); });
            await addImageFullSize(doc,logoDataUrl,65,y,70,20); 
            y+=28;
        }catch(e){console.warn('Logo:',e);}

        doc.setFontSize(14); doc.setTextColor(0);
        doc.text(t.studyTitle,10,y); y+=8;
        doc.setFontSize(11);
        doc.text(`${t.cliente} ${document.getElementById('cliente').value || ''}`,10,y); y+=6;
        doc.text(`${t.maquina} ${document.getElementById('maquina').value || ''}`,10,y); y+=6;
        doc.text(`${t.ano} ${document.getElementById('ano').value || ''}`,10,y); y+=8;

        // Fotos CE e Geral
        for(const fileInput of ['fotoCE','fotoGeral']){
            const file=document.getElementById(fileInput)?.files[0];
            if(file){
                doc.text(fileInput==='fotoCE'?t.ce:t.geral,10,y); y+=6;
                const dataUrl=await fileToDataURLResized(file,1200,1200,0.8);
                const h=await addImageFullSize(doc,dataUrl,10,y,fileInput==='fotoCE'?90:180, fileInput==='fotoCE'?80:120);
                y+=h;
            }
        }

        // Funções
        const items=document.querySelectorAll('.item');
        for(const item of items){
            doc.setFontSize(12); doc.text(item.querySelector('.hFuncao').innerText,10,y); y+=6;
            doc.setFontSize(11); doc.text(`${t.descricao} ${item.querySelector('.descricao').value || ''}`,10,y); y+=6;
            const pl=item.querySelector('.plDisplay').innerText;
            doc.text(`${t.plCalculado} ${pl}`,10,y); y+=6;

            for(const f of ['foto1','foto2','foto3']){
                const file=item.querySelector('.'+f)?.files[0];
                if(file){
                    const dataUrl=await fileToDataURLResized(file,1200,1200,0.8);
                    const img = new Image(); img.src=dataUrl;
                    await new Promise(res=> img.onload=res);
                    const w=img.width*25.4/96; const h=img.height*25.4/96;
                    y = checkPageSpace(doc, y, h);
                    doc.addImage(dataUrl,'JPEG',10,y,w>180?180:w,h>120?120:h);
                    y+=h+8;
                }
            }
            y+=4;
        }

        doc.save(`Estudo_Seguranca_${Date.now()}.pdf`);
    }catch(e){ alert('Erro a gerar PDF: '+e.message); console.error(e); }
    finally{ btn.disabled=false; loadingMsg.style.display='none'; }
}
</script>
</body>
</html>
