<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Estudo de Segurança</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #2D2D2D;
        color: #F4F3F2;
    }

    .topo {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 25px;
        position: relative;
    }

    .idioma-container {
        position: absolute;
        top: 0;
        right: 0;
    }

    #langSelect {
        padding: 4px 6px;
        font-size: 0.75em;
        background-color: #FFFFFF;
        color: #333;
        border: 1px solid #CCC;
        border-radius: 4px;
        width: auto;
    }

    .logo {
        height: 50px;
        margin-right: 15px;
    }

    h2#titulo {
        margin: 0;
        font-size: 1.4em;
        color: #F4F3F2;
    }

    .item, .study-box {
        border: 1px solid #555;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #3A3A3A;
    }

    .item label,
	.item textarea,
	.item select,
	.item .plCalc {
 	   margin-bottom: 6px;
  	  display: block;
	}

	input[type="file"] {
        margin-bottom: 8px;
	}

	.item textarea.descricao {
	    width: 450px;
	}

    @media (max-width: 600px) {
        .item textarea.descricao,
        .item select.S,
        .item select.F,
        .item select.P {
            width: 100% !important;
        }
    }

	.item select.S,
	.item select.F,
	.item select.P {
        width: 250px;
	}

    textarea, input[type="text"], input[type="number"], select {
        width: 100%;
        background-color: #4A4A4A;
        color: #F4F3F2;
        border: 1px solid #777;
        padding: 6px;
        border-radius: 4px;
        box-sizing: border-box;
    }

    #cliente, #maquina {
        width: 450px;
    }

    #ano {
        width: 70px;
        text-align: center;
    }

    input[type="file"] {
        width: 100%;
        margin-top: 8px;
        color: #F4F3F2;
    }

    button {
        padding: 10px 16px;
        background-color: #00448B;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    button:hover {
        background-color: #003366;
    }

    label.inline {
        display: block;
        margin-top: 10px;
    }

    @media (max-width: 600px) {
        #cliente, #maquina { width: 100%; }
        #ano { width: 100px; }
    }
</style>
</head>
<body>

<div class="topo">
    <img src="https://www.euchner.pt/wp-content/themes/euchner/img/logo.png" class="logo" alt="logo">

    <h2 id="titulo">Estudo de Segurança</h2>

    <div class="idioma-container">
        <select id="langSelect" onchange="atualizarIdioma()">
            <option value="pt">PT</option>
            <option value="es">ES</option>
            <option value="en">EN</option>
        </select>
    </div>
</div>

<div class="study-box">
    <h3 id="studyTitle">Relatório Estudo de Segurnça</h3>

    <label for="cliente" id="lblCliente" class="inline">Cliente:</label>
    <input type="text" id="cliente">

    <label for="maquina" id="lblMaquina" class="inline">Nome e Modelo da Máquina:</label>
    <input type="text" id="maquina">

    <label for="ano" id="lblAno" class="inline">Ano de Fabrico:</label>
    <input type="text" id="ano" maxlength="4">

    <label for="fotoCE" id="lblCE" class="inline">Marcação CE da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoCE">

    <label for="fotoGeral" id="lblGeral" class="inline">Foto Geral da Máquina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoGeral">
</div>

<div id="container"></div>

<button id="btnAdd" onclick="addItem()">Adicionar Função</button>
<button id="btnPDF" onclick="gerarPDF()">Gerar PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

/* ------------------ TEXTOS MULTILINGUE (igual ao original) ------------------ */
const textos = { /* ... igual ao teu ... */ };

let contador = 0;

/* ------------------ IDIOMAS (igual ao teu) ------------------ */
function atualizarIdioma(){ /* ... igual ao teu ... */ }

/* ------------------ ADICIONAR FUNÇÃO (igual ao teu) ------------------ */
function addItem(){ /* ... igual ao teu ... */ }

/* ------------------ CALCULAR PL (igual ao teu) ------------------ */
function atualizarPL(el){ /* ... igual ... */ }
function calcularPL(item){ /* ... igual ... */ }

/* ===============================================================
    ***  CORREÇÃO DE ROTAÇÃO PARA IPHONE  ***
   =============================================================== */

function getOrientation(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const view = new DataView(e.target.result);

        if (view.getUint16(0, false) != 0xFFD8) return callback(-1);

        let offset = 2;
        while (offset < view.byteLength) {
            const marker = view.getUint16(offset, false);
            offset += 2;

            if (marker == 0xFFE1) {
                if (view.getUint32(offset += 2, false) != 0x45786966) return callback(-1);
                const little = view.getUint16(offset += 6, false) == 0x4949;
                offset += view.getUint32(offset + 4, little);
                const count = view.getUint16(offset, little);
                offset += 2;

                for (let i = 0; i < count; i++) {
                    const tag = offset + (i * 12);
                    if (view.getUint16(tag, little) == 0x0112) {
                        return callback(view.getUint16(tag + 8, little));
                    }
                }
            }
            else if ((marker & 0xFF00) != 0xFF00) break;
            else offset += view.getUint16(offset, false);
        }
        return callback(-1);
    };
    reader.readAsArrayBuffer(file);
}

async function fileToDataURL(file){
    return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = function(e){

            getOrientation(file, function(orientation){

                const img = new Image();
                img.onload = function(){

                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    let w = img.width;
                    let h = img.height;

                    if(orientation > 4){
                        canvas.width = h;
                        canvas.height = w;
                    } else {
                        canvas.width = w;
                        canvas.height = h;
                    }

                    switch(orientation){
                        case 2: ctx.translate(w, 0); ctx.scale(-1, 1); break;
                        case 3: ctx.translate(w, h); ctx.rotate(Math.PI); break;
                        case 4: ctx.translate(0, h); ctx.scale(1, -1); break;
                        case 5: ctx.rotate(0.5 * Math.PI); ctx.scale(1, -1); break;
                        case 6: ctx.rotate(0.5 * Math.PI); ctx.translate(0, -h); break;
                        case 7: ctx.rotate(0.5 * Math.PI); ctx.translate(w, -h); ctx.scale(-1, 1); break;
                        case 8: ctx.rotate(-0.5 * Math.PI); ctx.translate(-w, 0); break;
                        default: break;
                    }

                    ctx.drawImage(img, 0, 0);

                    resolve(canvas.toDataURL("image/jpeg", 0.9));
                };

                img.src = e.target.result;
            });
        };

        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

/* ------------------ ADICIONAR IMAGENS AO PDF ------------------ */
async function addImageFullSize(doc, dataUrl, x, y, maxW = 180, maxH = 120){
    return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
            const pxToMm = px => px * 25.4 / 96;
            let w = pxToMm(img.width);
            let h = pxToMm(img.height);

            if(w > maxW || h > maxH){
                const r = Math.min(maxW/w, maxH/h);
                w *= r; h *= r;
            }

            doc.addImage(dataUrl, 'JPEG', x, y, w, h);
            resolve(h + 8);
        };
        img.src = dataUrl;
    });
}

/* ------------------ GERAR PDF (igual ao teu, só usa fileToDataURL corrigido) ------------------ */
async function gerarPDF(){ /* ... igual ao teu ... */ }

atualizarIdioma();
</script>
</body>
</html>
