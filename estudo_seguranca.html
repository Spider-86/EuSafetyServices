<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Estudo de Seguran√ßa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background-color: #2D2D2D;
        color: #F4F3F2;
    }

    .topo {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin-bottom: 25px;
        position: relative;
    }

    .idioma-container {
        position: absolute;
        top: 0;
        right: 0;
    }

    #langSelect {
        padding: 4px 6px;
        font-size: 0.75em;
        background-color: #FFFFFF;
        color: #333;
        border: 1px solid #CCC;
        border-radius: 4px;
        width: auto;
    }

    .logo {
        height: 50px;
        margin-right: 15px;
    }

    h2#titulo {
        margin: 0;
        font-size: 1.4em;
        color: #F4F3F2;
    }

    .item, .study-box {
        border: 1px solid #555;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #3A3A3A;
    }

    .item label,
	.item textarea,
	.item select,
	.item .plCalc {
 	   margin-bottom: 6px;
  	  display: block;
	}

	input[type="file"] {
        margin-bottom: 8px;
	}

	.item textarea.descricao {
	    width: 450px;
	}

    @media (max-width: 600px) {
        .item textarea.descricao,
        .item select.S,
        .item select.F,
        .item select.P {
            width: 100% !important;
        }
    }

	.item select.S,
	.item select.F,
	.item select.P {
        width: 250px;
	}

    textarea, input[type="text"], input[type="number"], select {
        width: 100%;
        background-color: #4A4A4A;
        color: #F4F3F2;
        border: 1px solid #777;
        padding: 6px;
        border-radius: 4px;
        box-sizing: border-box;
    }

    #cliente, #maquina {
        width: 450px;
    }

    #ano {
        width: 70px;
        text-align: center;
    }

    input[type="file"] {
        width: 100%;
        margin-top: 8px;
        color: #F4F3F2;
    }

    button {
        padding: 10px 16px;
        background-color: #00448B;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    button:hover {
        background-color: #003366;
    }

    label.inline {
        display: block;
        margin-top: 10px;
    }

    @media (max-width: 600px) {
        #cliente, #maquina { width: 100%; }
        #ano { width: 100px; }
    }
</style>
</head>
<body>

<div class="topo">
    <img src="https://www.euchner.pt/wp-content/themes/euchner/img/logo.png" class="logo" alt="logo">

    <h2 id="titulo">Estudo de Seguran√ßa</h2>

    <div class="idioma-container">
        <select id="langSelect" onchange="atualizarIdioma()">
            <option value="pt">PT</option>
            <option value="es">ES</option>
            <option value="en">EN</option>
        </select>
    </div>
</div>

<div class="study-box">
    <h3 id="studyTitle">Relat√≥rio Estudo de Segurn√ßa</h3>

    <label for="cliente" id="lblCliente" class="inline">Cliente:</label>
    <input type="text" id="cliente">

    <label for="maquina" id="lblMaquina" class="inline">Nome e Modelo da M√°quina:</label>
    <input type="text" id="maquina">

    <label for="ano" id="lblAno" class="inline">Ano de Fabrico:</label>
    <input type="text" id="ano" maxlength="4">

    <label for="fotoCE" id="lblCE" class="inline">Marca√ß√£o CE da M√°quina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoCE">

    <label for="fotoGeral" id="lblGeral" class="inline">Foto Geral da M√°quina:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoGeral">
</div>

<div id="container"></div>

<button id="btnAdd" onclick="addItem()">Adicionar Fun√ß√£o</button>
<button id="btnPDF" onclick="gerarPDF()">Gerar PDF</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

/* ---------------------------------------------------------------------
      TEXTOS MULTILINGUE  (mantive exatamente como tinhas)
------------------------------------------------------------------------ */
const textos = {
    pt: { /* ... mant√©m igual ... */ },
    es: { /* ... mant√©m igual ... */ },
    en: { /* ... mant√©m igual ... */ }
};

let contador = 0;

function atualizarIdioma(){ /* ... igual ... */ }

function addItem(){ /* ... igual ... */ }

function atualizarPL(el){ /* ... igual ... */ }
function calcularPL(item){ /* ... igual ... */ }


/* ======================================================================
      üî•  CORRE√á√ÉO DEFINITIVA DE ROTA√á√ÉO PARA iPHONE  (Chrome/Safari)
   ====================================================================== */

async function fileToDataURL(file){
    return new Promise((resolve, reject) => {

        const reader = new FileReader();

        reader.onload = function(e){
            const img = new Image();

            img.onload = function(){

                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                const w = img.width;
                const h = img.height;

                // --------- AQUI EST√Å A SOLU√á√ÉO QUE FUNCIONA NO IPHONE -------------
                // iPhone devolve sempre landscape mesmo quando √© portrait
                // Por isso: se width > height ‚Üí roda 90¬∞
                if (w > h) { 
                    canvas.width = h;
                    canvas.height = w;
                    ctx.translate(h, 0);
                    ctx.rotate(90 * Math.PI / 180);
                } else {
                    canvas.width = w;
                    canvas.height = h;
                }

                ctx.drawImage(img, 0, 0);

                resolve(canvas.toDataURL("image/jpeg", 0.92));
            };

            img.src = e.target.result;
        };

        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

/* ----------------------------------------------------------------------
   Adicionar imagens ao PDF (igual ao teu)
------------------------------------------------------------------------ */
async function addImageFullSize(doc, dataUrl, x, y, maxW=180, maxH=120){
    return new Promise(resolve=>{
        const img = new Image();
        img.onload = ()=>{
            const pxToMm = px => px * 25.4 / 96;
            let w = pxToMm(img.width);
            let h = pxToMm(img.height);

            if(w > maxW || h > maxH){
                const ratio = Math.min(maxW/w, maxH/h);
                w *= ratio;
                h *= ratio;
            }

            doc.addImage(dataUrl, 'JPEG', x, y, w, h);
            resolve(h + 8);
        };
        img.src = dataUrl;
    });
}

/* ----------------------------------------------------------------------
    Gerar PDF (igual ao teu)
------------------------------------------------------------------------ */
async function gerarPDF(){ /* ... igual ao teu ... */ }

atualizarIdioma();
</script>

</body>
</html>
